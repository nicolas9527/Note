<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="theme-color" content="#1976d2" />
  <title>Ghi ch√∫ ‚Ä¢ Copy nhanh</title>

  <style>
    :root{
      --primary:#1976d2;
      --bg:#f3f6fb;
      --text:#0f172a;
      --muted:#64748b;
      --border:#e2e8f0;
      --danger:#dc2626;
      --shadow: 0 10px 30px rgba(2,6,23,.08);
      --radius:14px;

      --dur: 180ms;
      --ease: cubic-bezier(.2,.8,.2,1);
    }

    *{box-sizing:border-box}
    html{ -webkit-text-size-adjust:100%; }
    body{
      margin:0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
      background: linear-gradient(180deg, #eaf3ff, var(--bg));
      color:var(--text);
    }

    header{
      position: sticky;
      top:0;
      z-index:10;
      backdrop-filter: blur(10px);
      background: rgba(243,246,251,.75);
      border-bottom:1px solid rgba(226,232,240,.8);
    }
    .wrap{
      max-width: 980px;
      margin: 0 auto;
      padding: 14px 14px 30px;
    }
    .titleRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding: 10px 0 6px;
    }
    .brand{
      display:flex;align-items:center;gap:10px;
      font-weight:800;
      letter-spacing:.2px;
    }
    .dot{
      width:34px;height:34px;border-radius:10px;
      background: radial-gradient(circle at 30% 30%, #90caf9, #1976d2);
      box-shadow: 0 8px 18px rgba(25,118,210,.35);
    }
    .sub{font-size:12px;color:var(--muted);font-weight:600;margin-top:2px}

    .btn{
      border:1px solid var(--border);
      background:#fff;
      color: var(--text);
      padding: 10px 12px;
      border-radius: 12px;
      font-weight:700;
      cursor:pointer;
      box-shadow: 0 2px 10px rgba(2,6,23,.06);
      transition: transform 120ms var(--ease), background 120ms var(--ease), border-color 120ms var(--ease);
      -webkit-tap-highlight-color: transparent;
      user-select:none;
      white-space:nowrap;
    }
    .btn:active{transform:scale(.98)}
    .btn.primary{
      background: linear-gradient(180deg, #1f7ae0, var(--primary));
      border-color: rgba(25,118,210,.35);
      color:#fff;
      box-shadow: 0 10px 20px rgba(25,118,210,.28);
    }
    .btn.danger{
      background:#fff;
      border-color: rgba(220,38,38,.35);
      color: var(--danger);
    }
    .btn.ghost{ background: rgba(255,255,255,.6); }
    .mini{
      padding: 8px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 800;
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 14px;
      margin-top: 10px;
    }

    .card{
      background: rgba(255,255,255,.9);
      border: 1px solid rgba(226,232,240,.85);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      contain: layout paint style;
    }
    .cardHeader{
      padding: 12px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      border-bottom:1px solid rgba(226,232,240,.8);
      background: linear-gradient(180deg, rgba(255,255,255,.98), rgba(255,255,255,.78));
    }
    .cardHeader h3{
      margin:0;
      font-size: 14px;
      letter-spacing:.2px;
    }
    .cardBody{padding: 12px 14px}

    .row{
      display:flex; gap:10px; flex-wrap:wrap;
      align-items:center;
    }
    .hint{
      font-size: 12px;
      color: var(--muted);
      margin-top: 8px;
      line-height:1.35;
    }
    .mutedSmall{font-size:12px;color:var(--muted);font-weight:700}

    /* ===== Collapsible editor ===== */
    .editorPanel{
      display:grid;
      grid-template-rows: 0fr;
      transition: grid-template-rows var(--dur) var(--ease);
    }
    .editorOpen .editorPanel{ grid-template-rows: 1fr; }
    .editorInner{ overflow:hidden; }

    .editorMotion{
      transform: translate3d(0,-6px,0);
      opacity: 0;
      will-change: transform, opacity;
      transition: transform var(--dur) var(--ease), opacity var(--dur) var(--ease);
      content-visibility: auto;
      contain-intrinsic-size: 280px;
    }
    .editorOpen .editorMotion{
      transform: translate3d(0,0,0);
      opacity: 1;
    }

    .editorHeaderClickable{
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }

    .toggleBtn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width: 40px;
      height: 34px;
      border-radius: 12px;
      border:1px solid var(--border);
      background:#fff;
      font-weight: 1000;
      cursor:pointer;
      box-shadow: 0 2px 10px rgba(2,6,23,.06);
      -webkit-tap-highlight-color: transparent;
      user-select:none;
      transition: transform 120ms var(--ease);
      flex: 0 0 auto;
    }
    .toggleBtn:active{transform:scale(.98)}
    .toggleIcon{
      font-size: 18px;
      line-height: 1;
      transform: translateY(-1px);
    }

    /* ===== Fields with clear (X) ===== */
    .field{ display:flex; flex-direction:column; gap:6px; margin-bottom:10px; }
    label{ font-size: 12px; color: var(--muted); font-weight: 700; }
    .inputWrap{ position: relative; }
    input[type="text"], textarea{
      width:100%;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px 12px;
      font-size: 14px;
      outline:none;
      background:#fff;
    }
    input[type="text"]{ padding-right: 42px; }
    textarea{
      min-height: 170px;
      resize: vertical;
      line-height: 1.45;
      padding-right: 42px;
    }
    input:focus, textarea:focus{
      border-color: rgba(25,118,210,.55);
      box-shadow: 0 0 0 3px rgba(25,118,210,.14);
    }
    .clearBtn{
      position:absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      width: 28px;
      height: 28px;
      border-radius: 999px;
      border: 1px solid rgba(226,232,240,.9);
      background: rgba(255,255,255,.95);
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight: 900;
      color: #64748b;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
      box-shadow: 0 6px 16px rgba(2,6,23,.08);
      opacity: 0;
      pointer-events:none;
      transition: opacity 120ms var(--ease), transform 120ms var(--ease);
    }
    .clearBtn.show{ opacity: 1; pointer-events:auto; }
    .clearBtn:active{ transform: translateY(-50%) scale(.96); }

    .clearBtn.textarea{
      top: 12px;
      transform: none;
    }
    .clearBtn.textarea:active{ transform: scale(.96); }

    /* ===== List toolbar ===== */
    .toolbar{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      width:100%;
    }
    .search{
      flex: 1 1 220144;
      min-width: 220px;
      display:flex;
      gap:10px;
      align-items:center;
    }
    .search input{flex:1; padding-right:12px;}

    /* ===== List items ===== */
    .list{
      display:flex;
      flex-direction:column;
      gap:10px;
      padding: 12px 14px 14px;
    }
    .item{
      border:1px solid rgba(226,232,240,.9);
      border-radius: 14px;
      background: rgba(255,255,255,.92);
      box-shadow: 0 8px 18px rgba(2,6,23,.05);
      overflow:hidden;
    }
    .itemTop{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      padding: 10px 12px;
    }
    .itemTitle{
      font-weight:900;
      font-size: 14px;
      margin:0;
      line-height:1.25;
      word-break:break-word;
    }
    .meta{
      font-size: 11px;
      color: var(--muted);
      margin-top:4px;
      font-weight:600;
    }
    .badgePin{
      display:inline-flex;
      align-items:center;
      gap:6px;
      font-size:11px;
      font-weight:800;
      color:#0b4aa2;
      background: rgba(100,181,246,.25);
      border:1px solid rgba(100,181,246,.45);
      padding: 4px 8px;
      border-radius:999px;
      white-space:nowrap;
    }
    .itemBtns{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    /* Preview clamp + ‚ÄúXem th√™m‚Äù */
    .itemPreview{
      padding: 0 12px 12px;
      color:#111827;
      opacity:.92;
      font-size: 13px;
      line-height:1.35;
      white-space: pre-wrap;
      word-break: break-word;
    }
    .clamp{
      display: -webkit-box;
      -webkit-box-orient: vertical;
      -webkit-line-clamp: 4;
      overflow: hidden;
    }
    .moreRow{
      padding: 0 12px 12px;
      margin-top: -6px;
    }
    .moreBtn{
      border:none;
      background: transparent;
      color: var(--primary);
      font-weight: 900;
      cursor:pointer;
      padding: 0;
      -webkit-tap-highlight-color: transparent;
    }
    .moreBtn:active{ opacity:.75; }

    .empty{
      padding: 22px 14px;
      text-align:center;
      color: var(--muted);
      font-weight: 800;
    }

    /* Toast */
    .toast{
      position: fixed;
      left: 50%;
      bottom: calc(18px + env(safe-area-inset-bottom));
      transform: translate3d(-50%,0,0);
      background: rgba(15,23,42,.92);
      color:#fff;
      padding: 10px 12px;
      border-radius: 12px;
      font-size: 13px;
      font-weight: 800;
      box-shadow: 0 18px 40px rgba(0,0,0,.25);
      opacity:0;
      pointer-events:none;
      transition: opacity 140ms var(--ease), transform 140ms var(--ease);
      z-index:9999;
      will-change: transform, opacity;
    }
    .toast.show{
      opacity:1;
      transform: translate3d(-50%,-2px,0);
    }

    @media (prefers-reduced-motion: reduce){
      :root{ --dur: 1ms; }
      .editorPanel, .editorMotion, .toast, .btn, .clearBtn { transition: none !important; }
    }
  </style>
</head>

<body>
  <header>
    <div class="wrap">
      <div class="titleRow">
        <div>
          <div class="brand">
            <span class="dot"></span>
            <div>
              <div>GHI CH√ö ‚Ä¢ COPY NHANH</div>
              <div class="sub">T·ª± l∆∞u ‚Ä¢ T√¨m ki·∫øm ‚Ä¢ Ghim ‚Ä¢ Copy 1 ch·∫°m</div>
            </div>
          </div>
        </div>
        <button class="btn ghost" id="btnExport" title="Xu·∫•t d·ªØ li·ªáu ra file .json">Xu·∫•t JSON</button>
      </div>
    </div>
  </header>

  <main class="wrap">
    <div class="grid">

      <!-- SO·∫†N GHI CH√ö -->
      <section class="card" id="editorCard">
        <div class="cardHeader editorHeaderClickable" id="editorHeader" role="button" aria-label="M·ªü/Thu nh·ªè so·∫°n ghi ch√∫" tabindex="0">
          <h3>So·∫°n ghi ch√∫</h3>
          <div class="row" style="gap:8px;">
            <div class="mutedSmall" id="status">‚Äî</div>
            <button class="toggleBtn" id="btnToggleEditor" aria-expanded="false" title="M·ªü/Thu nh·ªè">
              <span class="toggleIcon" id="toggleIcon">+</span>
            </button>
          </div>
        </div>

        <div class="editorPanel">
          <div class="editorInner">
            <div class="editorMotion">
              <div class="cardBody">

                <div class="field">
                  <label for="title">Ti√™u ƒë·ªÅ</label>
                  <div class="inputWrap">
                    <input id="title" type="text" placeholder="VD: M√£ WiFi, N·ªôi dung c·∫ßn copy, ..." />
                    <button class="clearBtn" id="clearTitle" type="button" aria-label="Xo√° ti√™u ƒë·ªÅ">‚úï</button>
                  </div>
                </div>

                <div class="field">
                  <label for="content">N·ªôi dung</label>
                  <div class="inputWrap">
                    <textarea id="content" placeholder="Nh·∫≠p ghi ch√∫ ·ªü ƒë√¢y..."></textarea>
                    <button class="clearBtn textarea" id="clearContent" type="button" aria-label="Xo√° n·ªôi dung">‚úï</button>
                  </div>
                </div>

                <div class="row">
                  <button class="btn primary" id="btnSave">L∆∞u / C·∫≠p nh·∫≠t</button>
                  <button class="btn" id="btnCopy">Copy n·ªôi dung</button>
                  <button class="btn" id="btnNew">T·∫°o m·ªõi</button>
                  <button class="btn danger" id="btnDelete" disabled>X√≥a</button>
                </div>

                <div class="hint">
                  C√≥ n√∫t <b>‚úï</b> ƒë·ªÉ xo√° nhanh. Danh s√°ch hi·ªÉn th·ªã ng·∫Øn + <b>‚Ä¶ Xem th√™m</b>.
                </div>

              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- DANH S√ÅCH -->
      <section class="card">
        <div class="cardHeader">
          <h3>Danh s√°ch ghi ch√∫</h3>
          <div class="toolbar">
            <div class="search">
              <input id="search" type="text" placeholder="T√¨m theo ti√™u ƒë·ªÅ / n·ªôi dung..." />
              <button class="btn mini" id="btnCopyAll" title="Copy t·∫•t c·∫£ ghi ch√∫">Copy all</button>
            </div>
          </div>
        </div>

        <div class="list" id="list"></div>
        <div class="empty" id="empty" style="display:none">
          Ch∆∞a c√≥ ghi ch√∫ n√†o.<br/>B·∫•m <b>So·∫°n ghi ch√∫</b> ƒë·ªÉ m·ªü v√† t·∫°o.
        </div>
      </section>

    </div>
  </main>

  <div class="toast" id="toast">ƒê√£ copy</div>

<script>
(() => {
  const $ = (id) => document.getElementById(id);

  const els = {
    editorCard: $("editorCard"),
    editorHeader: $("editorHeader"),
    btnToggleEditor: $("btnToggleEditor"),
    toggleIcon: $("toggleIcon"),

    title: $("title"),
    content: $("content"),
    clearTitle: $("clearTitle"),
    clearContent: $("clearContent"),

    btnSave: $("btnSave"),
    btnCopy: $("btnCopy"),
    btnNew: $("btnNew"),
    btnDelete: $("btnDelete"),
    status: $("status"),

    list: $("list"),
    empty: $("empty"),
    search: $("search"),
    btnCopyAll: $("btnCopyAll"),
    toast: $("toast"),
    btnExport: $("btnExport"),
  };

  const STORAGE_KEY = "quick_notes_v1";
  const UI_KEY = "quick_notes_ui_editor_open_v3";
  const EXPAND_KEY = "quick_notes_expanded_ids_v1";

  let notes = [];
  let selectedId = null;
  let toastTimer = null;

  // ‚Äúxem th√™m‚Äù theo id
  let expanded = new Set();
  try {
    const raw = localStorage.getItem(EXPAND_KEY);
    if (raw) expanded = new Set(JSON.parse(raw));
  } catch {}

  const persistExpanded = () => {
    try { localStorage.setItem(EXPAND_KEY, JSON.stringify([...expanded])); } catch {}
  };

  const nowISO = () => new Date().toISOString();
  const fmtTime = (iso) => {
    try {
      const d = new Date(iso);
      return d.toLocaleString("vi-VN", { hour12:false });
    } catch { return ""; }
  };
  const uid = () => (crypto?.randomUUID?.() || ("id_" + Math.random().toString(16).slice(2) + Date.now()));
  const normalize = (s) => (s || "").toString().toLowerCase();

  const load = () => {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      notes = raw ? JSON.parse(raw) : [];
      if (!Array.isArray(notes)) notes = [];
    } catch { notes = []; }
  };
  const saveStore = () => localStorage.setItem(STORAGE_KEY, JSON.stringify(notes));

  const showToast = (msg) => {
    els.toast.textContent = msg;
    els.toast.classList.add("show");
    clearTimeout(toastTimer);
    toastTimer = setTimeout(() => els.toast.classList.remove("show"), 1200);
  };

  const setStatus = (msg) => els.status.textContent = msg || "‚Äî";

  // ===== Editor open/close =====
  const setEditorOpen = (open, focus = true) => {
    const isOpen = els.editorCard.classList.contains("editorOpen");
    if (open === isOpen) return;

    if (open){
      els.editorCard.classList.add("editorOpen");
      els.toggleIcon.textContent = "‚Äì";
      els.btnToggleEditor.setAttribute("aria-expanded", "true");
      localStorage.setItem(UI_KEY, "1");

      if (focus){
        requestAnimationFrame(() => {
          setTimeout(() => (els.title.value ? els.content.focus() : els.title.focus()), 60);
        });
      }
    } else {
      els.editorCard.classList.remove("editorOpen");
      els.toggleIcon.textContent = "+";
      els.btnToggleEditor.setAttribute("aria-expanded", "false");
      localStorage.setItem(UI_KEY, "0");
    }
  };

  const toggleEditor = (focus = true) => {
    const isOpen = els.editorCard.classList.contains("editorOpen");
    setEditorOpen(!isOpen, focus);
  };

  // ===== N√∫t X hi·ªÉn th·ªã/·∫©n =====
  const updateClearBtns = () => {
    els.clearTitle.classList.toggle("show", (els.title.value || "").length > 0);
    els.clearContent.classList.toggle("show", (els.content.value || "").length > 0);
  };

  // ===== Filter/sort =====
  const filteredNotes = () => {
    const q = normalize(els.search.value).trim();
    let arr = [...notes];

    // pinned first + updated desc
    arr.sort((a,b) => {
      if (!!b.pinned !== !!a.pinned) return (b.pinned ? 1 : 0) - (a.pinned ? 1 : 0);
      return (b.updatedAt || "").localeCompare(a.updatedAt || "");
    }).reverse();

    if (!q) return arr;
    return arr.filter(n => normalize(n.title).includes(q) || normalize(n.content).includes(q));
  };

  const shouldShowMore = (text) => {
    return (text || "").length > 260 || (text || "").split("\n").length > 6;
  };

  const render = () => {
    const arr = filteredNotes();
    els.list.innerHTML = "";
    els.empty.style.display = arr.length ? "none" : "block";

    arr.forEach(n => {
      const item = document.createElement("div");
      item.className = "item";

      const top = document.createElement("div");
      top.className = "itemTop";

      const left = document.createElement("div");
      left.style.minWidth = "0";
      left.style.flex = "1";

      const title = document.createElement("div");
      title.className = "itemTitle";
      title.textContent = n.title || "(Kh√¥ng ti√™u ƒë·ªÅ)";

      const meta = document.createElement("div");
      meta.className = "meta";
      meta.innerHTML = `${fmtTime(n.updatedAt || n.createdAt)}${n.pinned ? ' ‚Ä¢ <span class="badgePin">üìå Ghim</span>' : ""}`;

      left.appendChild(title);
      left.appendChild(meta);

      const btns = document.createElement("div");
      btns.className = "itemBtns";

      const bOpen = document.createElement("button");
      bOpen.className = "btn mini";
      bOpen.textContent = "M·ªü";
      bOpen.onclick = () => selectNote(n.id);

      const bCopy = document.createElement("button");
      bCopy.className = "btn mini primary";
      bCopy.textContent = "Copy";
      bCopy.onclick = async () => {
        await copyText(n.content || "");
        showToast("ƒê√£ copy ghi ch√∫");
      };

      const bPin = document.createElement("button");
      bPin.className = "btn mini";
      bPin.textContent = n.pinned ? "B·ªè ghim" : "Ghim";
      bPin.onclick = () => {
        n.pinned = !n.pinned;
        n.updatedAt = nowISO();
        saveStore();
        render();
      };

      const bDel = document.createElement("button");
      bDel.className = "btn mini danger";
      bDel.textContent = "X√≥a";
      bDel.onclick = () => deleteNote(n.id);

      btns.appendChild(bOpen);
      btns.appendChild(bCopy);
      btns.appendChild(bPin);
      btns.appendChild(bDel);

      top.appendChild(left);
      top.appendChild(btns);

      const preview = document.createElement("div");
      preview.className = "itemPreview";
      const isExpanded = expanded.has(n.id);
      preview.classList.toggle("clamp", !isExpanded);
      preview.textContent = (n.content || "");

      if (n.id === selectedId){
        item.style.borderColor = "rgba(25,118,210,.55)";
        item.style.boxShadow = "0 10px 26px rgba(25,118,210,.14)";
      }

      item.appendChild(top);
      item.appendChild(preview);

      if (shouldShowMore(n.content || "")){
        const moreRow = document.createElement("div");
        moreRow.className = "moreRow";

        const moreBtn = document.createElement("button");
        moreBtn.className = "moreBtn";
        moreBtn.type = "button";
        moreBtn.textContent = isExpanded ? "Thu g·ªçn" : "‚Ä¶ Xem th√™m";
        moreBtn.onclick = () => {
          if (expanded.has(n.id)) expanded.delete(n.id);
          else expanded.add(n.id);
          persistExpanded();
          render();
        };

        moreRow.appendChild(moreBtn);
        item.appendChild(moreRow);
      }

      els.list.appendChild(item);
    });
  };

  const clearEditor = () => {
    selectedId = null;
    els.title.value = "";
    els.content.value = "";
    els.btnDelete.disabled = true;
    setStatus("T·∫°o m·ªõi");
    updateClearBtns();
  };

  const selectNote = (id) => {
    const n = notes.find(x => x.id === id);
    if (!n) return;
    selectedId = id;
    els.title.value = n.title || "";
    els.content.value = n.content || "";
    els.btnDelete.disabled = false;
    setStatus("ƒêang s·ª≠a");
    updateClearBtns();
    render();
    setEditorOpen(true, true);
  };

  const upsert = () => {
    const title = (els.title.value || "").trim();
    const content = (els.content.value || "").trim();

    if (!title && !content){
      showToast("Nh·∫≠p ti√™u ƒë·ªÅ ho·∫∑c n·ªôi dung tr∆∞·ªõc nh√©");
      return;
    }

    if (selectedId){
      const n = notes.find(x => x.id === selectedId);
      if (!n) return;
      n.title = title;
      n.content = content;
      n.updatedAt = nowISO();
      saveStore();
      showToast("ƒê√£ c·∫≠p nh·∫≠t");
      setStatus("ƒê√£ c·∫≠p nh·∫≠t");
    } else {
      const n = {
        id: uid(),
        title,
        content,
        pinned: false,
        createdAt: nowISO(),
        updatedAt: nowISO()
      };
      notes.push(n);
      selectedId = n.id;
      saveStore();
      showToast("ƒê√£ l∆∞u");
      setStatus("ƒê√£ l∆∞u");
      els.btnDelete.disabled = false;
    }

    updateClearBtns();
    render();
  };

  const deleteNote = (id) => {
    const n = notes.find(x => x.id === id);
    if (!n) return;
    const ok = confirm(`X√≥a ghi ch√∫: "${n.title || "(Kh√¥ng ti√™u ƒë·ªÅ)"}" ?`);
    if (!ok) return;

    notes = notes.filter(x => x.id !== id);
    expanded.delete(id);
    persistExpanded();

    if (selectedId === id) clearEditor();
    saveStore();
    render();
    showToast("ƒê√£ x√≥a");
  };

  const copyText = async (text) => {
    try {
      await navigator.clipboard.writeText(text);
      return true;
    } catch (e) {
      const ta = document.createElement("textarea");
      ta.value = text;
      ta.setAttribute("readonly", "");
      ta.style.position = "fixed";
      ta.style.left = "-9999px";
      document.body.appendChild(ta);
      ta.select();
      try { document.execCommand("copy"); } catch {}
      document.body.removeChild(ta);
      return true;
    }
  };

  const copyCurrent = async () => {
    const text = (els.content.value || "").trim();
    if (!text){
      showToast("Ch∆∞a c√≥ n·ªôi dung ƒë·ªÉ copy");
      return;
    }
    await copyText(text);
    showToast("ƒê√£ copy n·ªôi dung");
  };

  const copyAll = async () => {
    if (!notes.length){
      showToast("Kh√¥ng c√≥ ghi ch√∫ n√†o");
      return;
    }
    const arr = filteredNotes();
    const joined = arr.map((n) => {
      const t = n.title ? `# ${n.title}` : `# (Kh√¥ng ti√™u ƒë·ªÅ)`;
      const c = (n.content || "");
      return `${t}\n${c}\n`;
    }).join("\n");
    await copyText(joined.trim());
    showToast("ƒê√£ copy t·∫•t c·∫£");
  };

  const exportJSON = () => {
    const data = JSON.stringify(notes, null, 2);
    const blob = new Blob([data], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "ghi-chu-backup.json";
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(() => URL.revokeObjectURL(url), 1500);
    showToast("ƒê√£ xu·∫•t JSON");
  };

  // ===== Events =====
  els.btnSave.addEventListener("click", upsert);
  els.btnCopy.addEventListener("click", copyCurrent);
  els.btnNew.addEventListener("click", () => { clearEditor(); render(); setEditorOpen(true, true); });
  els.btnDelete.addEventListener("click", () => { if (selectedId) deleteNote(selectedId); });

  els.search.addEventListener("input", render);
  els.btnCopyAll.addEventListener("click", copyAll);
  els.btnExport.addEventListener("click", exportJSON);

  // Toggle +/-
  els.btnToggleEditor.addEventListener("click", (e) => {
    e.stopPropagation();
    toggleEditor(true);
  });

  // B·∫•m c·∫£ thanh header
  els.editorHeader.addEventListener("click", () => toggleEditor(true));
  els.editorHeader.addEventListener("keydown", (e) => {
    const k = (e.key || "").toLowerCase();
    if (k === "enter" || k === " "){
      e.preventDefault();
      toggleEditor(true);
    }
  });

  // Clear buttons
  els.title.addEventListener("input", updateClearBtns);
  els.content.addEventListener("input", updateClearBtns);

  els.clearTitle.addEventListener("click", (e) => {
    e.stopPropagation();
    els.title.value = "";
    updateClearBtns();
    els.title.focus();
  });

  els.clearContent.addEventListener("click", (e) => {
    e.stopPropagation();
    els.content.value = "";
    updateClearBtns();
    els.content.focus();
  });

  // Keyboard shortcuts
  window.addEventListener("keydown", (e) => {
    const key = (e.key || "").toLowerCase();
    if ((e.ctrlKey || e.metaKey) && key === "s"){
      e.preventDefault();
      upsert();
    }
    if (key === "escape"){
      setEditorOpen(false, false);
    }
  }, {passive:false});

  // Init
  load();
  clearEditor();
  render();
  updateClearBtns();
  setEditorOpen(localStorage.getItem(UI_KEY) === "1", false);
})();
</script>
</body>
</html>